name: CI

on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    env:
      PGTAPME_DB_USER: dbo
      PGTAPME_DB_PASSWORD: ${{ secrets.PGTAPME_DB_PASSWORD || 'mysecretpassword' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Configure pgpass credentials
        run: |
          cat <<'PGPASS' > .pgpass
          *:*:*:${PGTAPME_DB_USER}:${PGTAPME_DB_PASSWORD}
          PGPASS
          chmod 600 .pgpass

      - name: Prepare generated tests directory
        run: |
          mkdir -p code/pgtapme_generated_files
          chmod 777 code/pgtapme_generated_files

      - name: Build containers
        run: docker compose build

      - name: Start services
        run: docker compose up -d

      - name: Wait for Docker services to become ready
        run: |
          set -euo pipefail
          services=$(docker compose ps --services)
          for attempt in $(seq 1 30); do
            not_ready=0
            echo "--- compose status (attempt ${attempt}) ---"
            for service in $services; do
              container_id=$(docker compose ps -q "$service")
              if [ -z "$container_id" ]; then
                echo "Service $service container ID not available yet"
                not_ready=1
                continue
              fi
              status=$(docker inspect -f '{{.State.Status}}' "$container_id")
              health=$(docker inspect -f '{{if .State.Health}}{{.State.Health.Status}}{{end}}' "$container_id")
              if [ -n "$health" ]; then
                echo "Service $service state=$status health=$health"
                if [ "$health" != "healthy" ]; then
                  not_ready=1
                fi
              else
                echo "Service $service state=$status"
                if [ "$status" != "running" ]; then
                  not_ready=1
                fi
              fi
            done
            if [ "$not_ready" -eq 0 ]; then
              exit 0
            fi
            sleep 10
          done
          echo "Services did not become ready in time"
          docker compose ps
          exit 1

      - name: Deploy database schema with Sqitch
        run: docker compose exec -T sqitch env PGUSER=${PGTAPME_DB_USER} PGPASSWORD=${PGTAPME_DB_PASSWORD} sqitch deploy pgtapme --chdir /mnt/migrations

      - name: Generate pgTAP tests
        run: docker compose exec -T app python pgtapme.py --db-name pgtapme --db-user ${PGTAPME_DB_USER} --db-password ${PGTAPME_DB_PASSWORD} --db-host pgtapme_db --db-port 5432

      - name: Run pgTAP suite with pg_prove
        run: docker compose exec -T pg_prove env PGPASSWORD=${PGTAPME_DB_PASSWORD} pg_prove --ext .sql -r -U ${PGTAPME_DB_USER} -h pgtapme_db -d pgtapme -p 5432 -f /mnt/tests/pgtapme

      - name: Verify database with Sqitch
        run: docker compose exec -T sqitch env PGUSER=${PGTAPME_DB_USER} PGPASSWORD=${PGTAPME_DB_PASSWORD} sqitch verify pgtapme --chdir /mnt/migrations

      - name: Collect Docker logs
        if: failure()
        run: docker compose logs --no-color > docker-compose.log

      - name: Upload Docker logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: docker-compose-logs
          path: docker-compose.log

      - name: Archive generated pgTAP files
        if: always()
        run: |
          if [ -d code/pgtapme_generated_files ] && [ "$(find code/pgtapme_generated_files -type f | head -n1)" ]; then
            tar -czf pgtapme-generated-tests.tar.gz -C code pgtapme_generated_files
          else
            echo "No generated pgTAP files found; uploading empty archive"
            tar -czf pgtapme-generated-tests.tar.gz --files-from /dev/null
          fi

      - name: Upload generated pgTAP files
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pgtapme-generated-tests
          path: pgtapme-generated-tests.tar.gz
          if-no-files-found: warn

      - name: Tear down services
        if: always()
        run: docker compose down --volumes --remove-orphans
